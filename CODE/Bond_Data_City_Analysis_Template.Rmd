---
title: "Scripts for Official Statements from Bond Documents"
author: "Rachel Bash"
date: "10/22/2019"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Johnstown

####Setup

```{r setup}
# Load libraries
library(trend); library(calibrate); library(lubridate); library(reshape2)
library(rjson); library(dplyr); library(magrittr);  library(tidyr)
library(sp); library(rgdal); library(maptools); library(gplots); library(rgeos); library(raster)
library(stringr); library(PBSmapping); library(spData); library(sf); library(nationalparkcolors)
library(readxl); #in tidyverse
library(tidyverse);

rm(list=ls()) #removes anything stored in memory

#colors and theme
pal <- park_palette("SmokyMountains")
pal2 <- park_palette("Arches")
theme_set(theme_classic())
#devtools::install_github("katiejolly/nationalparkcolors")
```

#### Loading City Excel sheet

```{r}
swd_osData <- "C:/Users/19524/Documents/DUKE/MP/Shrinking_Cities_MP/DATA/RAW/"
fileName <- "os_PA4110034_Johnstown.xlsx"
```

#### Basic Info Spreadsheet
```{r}
basicInfo <- read_excel(paste0(swd_osData, fileName), sheet="basicInfo")

#plot bond value and start year
plot(basicInfo$startYear, basicInfo$bondAmount, pch=19, col="navy", cex=1.8, xlab="Bond Year",
     ylab="Bond Value (Millions)")
#group by year and plot
group.bonds <- basicInfo %>% group_by(OSYear) %>% 
  summarize(TotalValue = sum(bondAmount, na.rm=TRUE)) %>% 
  as.data.frame();
#plot bond value and all years
plot(group.bonds$OSYear, (group.bonds$TotalValue/1000000), pch=19, col="navy", cex=1.8, 
     xlab="Bond Year", ylab="Bond Value (Millions)")

all.years <- seq(min(basicInfo$OSYear), max(basicInfo$OSYear),1) %>% as.data.frame(); 
colnames(all.years)=c("OSYear")
all.years$TotalValue=0
group.bonds <- rbind(all.years, group.bonds); 
group.bonds <- group.bonds %>% 
  group_by(OSYear) %>% 
  summarize(TotalValue = sum(TotalValue, na.rm=TRUE)) %>% 
  as.data.frame();

#bar plot of total bond values for each bond year 
par(mar=c(4,4,3,1))  #par(mar = c(bottom, left, top, right))
barplot((group.bonds$TotalValue/1000000), names.arg=group.bonds$OSYear, main="Bonds with Official Statements", xlab="Bond Year", ylab="Total Bond Value ($Millions)", ylim=c(0,25))
```

#### Other Debt spreadsheet
```{r}
otherDebt <- read_excel(paste0(swd_osData, fileName), sheet="otherDebt"); head(otherDebt)

uniqueDebt <- otherDebt %>% distinct(debtName, .keep_all = TRUE)  %>% as.data.frame() 
  uniqueDebt <- uniqueDebt %>% dplyr::select(PWSID, debtName, type, amount, aveRate, startYear, endYear)
  
#plot type of debt and amount - combine bond series
typeDebt <- uniqueDebt %>%
  group_by(startYear, type) %>%
  summarise(totalamount = sum(amount),
            avgrate = mean(aveRate)
            )

ggplot(typeDebt, aes(x = startYear, y= totalamount/1000000, color = type, fill = type)) +
  geom_bar(stat = "identity") +
  labs(x="", y= "Total Bond Value ($ Millions)", color = "Type of Debt", fill = "Type of Debt") +
  scale_color_manual(values=pal) +
  scale_fill_manual(values=pal)
```


#### Usage spreadsheet

```{r}
usage <- read_excel(paste0(swd_osData, fileName), sheet="usage"); head(usage)

# Percent of Treated and Metered Water to Supply Capacity
capacity <- usage %>% filter(groupBy=="Capacity" & class=="Total") %>% group_by(year) %>% 
  summarize(capVol_MGD = median(volume_MGD, na.rm=TRUE))
treated <- usage %>% filter(groupBy=="Treated Water" & class=="Total") %>% group_by(year) %>% 
  summarize(treatVol_MGD = median(volume_MGD, na.rm=TRUE))
metered <- usage %>% filter(groupBy=="Metered Consumption") %>% group_by(year, class) %>% 
  summarize(meterVol_MGD = median(volume_MGD, na.rm=TRUE))

#combine total into one dataframe to get percent
totalUse <- merge(capacity, treated, by.x="year", by.y="year", all=TRUE)
totalUse <- merge(totalUse, subset(metered, class=="Total"), by.x="year", by.y="year", all=TRUE)
totalUse$treatPer <- round(totalUse$treatVol_MGD/totalUse$capVol_MGD*100,2)
totalUse$meterPer <- round(totalUse$meterVol_MGD/totalUse$capVol_MGD*100,2)


#Plot capacity, treated, and metered over time
par(mar=c(2,4,3,1))  #par(mar = c(bottom, left, top, right))
plot(totalUse$year, totalUse$capVol_MGD, type="n", xlab="", ylab="Average Daily Volume (MGD)", main=paste0(usage$name[1]," Water Supply and Usage Over Time"), ylim=c(0,max(totalUse$capVol_MGD+2)))
  lines(totalUse$year, totalUse$capVol_MGD, lwd=2, col="black")
  lines(totalUse$year, totalUse$treatVol_MGD, lwd=2, col=pal[1])
  lines(totalUse$year, totalUse$meterVol_MGD, lwd=2, col=pal[2])
legend("topleft", c("Capacity","Treated Water","Metered Water"), 
       col=c("black", pal[1], pal[2]), lwd=2)

#plot metered and treated as percent of total capacity
par(mar=c(2,4,3,1))  #par(mar = c(bottom, left, top, right))
plot(totalUse$year, totalUse$treatPer, type="n", xlab="", ylab="Percent of Total Capacity", main=paste0(usage$name[1]," Water Supply and Usage Over Time"), ylim=c(0,100))
  lines(totalUse$year, totalUse$treatPer, lwd=2, col=pal[1])
  lines(totalUse$year, totalUse$meterPer, lwd=2, col=pal[2])
  abline(h = 100, col="black", lwd=2)
  abline(h = 80, col=pal[3], lwd=3, lty=2)
legend("bottomleft", c("Capacity","Treated Water","Metered Water", "Demand is 80% of Supply"),
       col=c("black",pal[1],pal[2], pal[3]), lwd=2, lty=c(1,1,1,2))

```

#### Unaccounted spreadsheet

```{r}
unaccount <- read_excel(paste0(swd_osData, fileName), sheet="unaccounted"); head(unaccount)
#adjusted percent column may be a character if first values are NA
unaccount$adjustedPercent <- as.numeric(as.character(unaccount$adjustedPercent))
#summarize for duplicate years with different values
unaccount <- unaccount %>% 
  group_by(year, method) %>% 
  summarize(GrossPer = median(grossPercent, na.rm=TRUE), 
            AdjustedPer = median(adjustedPercent, na.rm=TRUE)) %>% 
  as.data.frame()

#add missing years so doesn't draw a line between
all.years <- seq(min(unaccount$year), max(unaccount$year),1) %>% 
  as.data.frame(); colnames(all.years)=c("year")
  all.years$method = NA;       all.years$GrossPer=NA;           all.years$AdjustedPer=NA;
all.years <- rbind(unaccount, all.years); 
  
#get rid of duplicate years
unaccount2 <- all.years %>% 
    group_by(year) %>% 
    summarize(GrossPer = median(GrossPer, na.rm=TRUE), 
              AdjustedPer = median(AdjustedPer, na.rm=TRUE)) %>% 
    arrange(year)
unaccount <- merge(unaccount2, unaccount[,c(1:2)], by.x="year", by.y="year", all.x=TRUE)

#leak estimate 
unaccount$leakEst = unaccount$GrossPer - unaccount$AdjustedPer

unaccount$pch <- ifelse(unaccount$method=="Reported", 19, 1);    
unaccount$pch <- ifelse(is.na(unaccount$method)==TRUE, NA, unaccount$pch);
unaccount$col <- ifelse(unaccount$method=="Reported", "black", rgb(0.2,0.2,0.2));    
unaccount$col <- ifelse(is.na(unaccount$method)==TRUE, NA, unaccount$col);

#plotting
par(mar=c(2,4,3,1))  #par(mar = c(bottom, left, top, right))
plot(unaccount$year, unaccount$GrossPer, type="n", xlab="", ylab="Percent of Treated Water", 
     main=paste0(usage$name[1]," Unaccounted Water Loss"), ylim=c(0,100), las=1) 
#las sets all labels horizontal
abline(h=c(10,20,30,40,50,60,70,80,90,100), lty=3, col="lightgray")
  lines(unaccount$year, unaccount$GrossPer, lwd=2, col="black");    
    points(unaccount$year, unaccount$GrossPer, pch=unaccount$pch, col=unaccount$col, cex=1.2)
  lines(unaccount$year, unaccount$AdjustedPer, lwd=2, col="goldenrod4");
  lines(unaccount$year, unaccount$leakEst, lwd=2, lty=2, col="red");    
legend("topleft", c("Estimated Gross Unaccounted Water","Reported Gross Unaccounted Water","Adjusted Unaccounted Water (known)", "Estimated Leaks"), 
       col=c("black","black","goldenrod4","red"), lwd=2, lty=c(1,1,1,2), pch=c(1,19,NA,NA), cex = 1.1)
  

```

#### Interconnections Spreadsheet

Number of connections by customer class and customer class changes over time (more updated spreadsheets do not have this tab)

```{r}
#read in data
customers <- read_excel(paste0(swd_osData, fileName), sheet="customers"); head(customers)
customers$nConnections = as.numeric(as.character(customers$nConnections))
  
#remove duplicates and pull out only by customer type
custType <- customers %>% filter(groupBy=="Customer") %>% group_by(year, class) %>% summarize(nConnections = median(nConnections, na.rm=TRUE))

#reshape the table
connects <- custType %>% spread(class, value=nConnections)
#reorder dataframe
connects <- connects[c("year", "Residential", "Industrial","Commercial","Public","Other Utilities")]

#plot customers over time
ggplot(custType) +
  geom_bar(aes(x=year, y=nConnections, fill=class), stat="identity") +
  scale_fill_manual(values=pal) +
  labs(x="Year", y="Number of Connections", fill = "Class", title = paste0(customers$name[1],": Number of Connections by Customer Class"))

```


#### Fiscal Data

```{r}
fiscal <- read_excel(paste0(swd_osData, fileName), sheet="fiscal"); head(fiscal)
#fix first row issue so that the column names are correct
names(fiscal) <- as.matrix(fiscal[1, ]); fiscal <- fiscal[-1, ]

#convert from character to numeric
fiscal[,c(5:dim(fiscal)[2])] <- sapply(fiscal[c(5:dim(fiscal)[2])],as.numeric)

#revenue
revenues <- fiscal %>% filter(category=="Revenues")
names.revenue = seq(1988,2017,1)

#create a bar plot of revenues over time
par(mar=c(2,4,3,1))  #par(mar = c(bottom, left, top, right))
#remove last row, which is the total
barplot((as.matrix(fiscal[c(1:dim(revenues)[1]-1),c(5:dim(revenues)[2])])/1000000), names.arg=names.revenue, main=paste0(fiscal$name[1],": Operating Revenue Generated"),
        col=c("navy","goldenrod4","darkred","lightblue","black","yellow","yellow2","seagreen3","plum2","azure4","olivedrab"), ylim=c(0,14), las=1, ylab="Revenues ($Millions)")
abline(h=0, col="black")
legend("topleft",head(unique(revenues$subcategory),-1), fill=c("navy","goldenrod4","darkred","lightblue","black","yellow","yellow2","seagreen3","plum2","azure4","olivedrab"),
       cex=0.8, ncol=2)
```


#### Rates

```{r}
#read in rate data to get years of known rate changes
rates <- read_excel(paste0(swd_osData, fileName), sheet="rates"); head(rates)
rateYearSet <- unique(rates$yearSet)

#picked gravity and flat charges arbitrarily. Did not look at consumption charges
ratesMeter <- rates %>%
  filter(charges=="Flat Charge" & otherClass=="Gravity")

#divide arbitrarily based on size of meter
ratesMeterHouse <- ratesMeter %>%
  filter(class %in% c("0.625", "0.75", "1", "1.5"))
ratesMeterComm <- ratesMeter %>%
  filter(class %in% c("2", "3", "4", "6", "8"))

#plot House sized meters and cost per year
ggplot(ratesMeterHouse, aes(x=rateYear, y=cost)) +
  geom_line(aes(color=class), size=1.5) +
  scale_color_manual(values=c(pal, pal2)) +
  labs(x="Year", y="Cost of Quarterly Water Bill ($)", title = paste0(rates$name[1],": Quarterly Water Bill for Residential Homes"), color="Size of Meter (in)")

ggplot(ratesMeterComm, aes(x=rateYear, y=cost)) +
  geom_line(aes(color=class), size=1.5) +
  scale_color_manual(values=c(pal, pal2)) +
  labs(x="Year", y="Cost of Quarterly Water Bill ($)", title = paste0(rates$name[1],": Quarterly Water Bill for Commercial Users"), color="Size of Meter (in)")
  
```

Rate changes over time 

**Need explanation for this part**

```{r}
#Average Rate for someone with a 0.75 inch pipe that uses 5000 gallons a month
hhrates <- subset(rates, charges=="Consumption Charge" & otherClass=="Pumping" | is.na(otherClass)==TRUE) %>% as.data.frame();  
hhmeter <- subset(rates, class=="0.75")

unique.year <- unique(hhrates$rateYear)
hh.quarter <- as.data.frame(matrix(nrow=length(unique.year),ncol=5)); 
colnames(hh.quarter) <- c("PWSID","Name","Year","Flat","cost15k")
hh.quarter$PWSID <- as.character(rates$PWSID[1])
hh.quarter$Name <- as.character(rates$name[1])  
hh.quarter$Year <- unique.year

for(i in 1:length(unique.year)){
  zt.flat <- subset(hhmeter, rateYear==unique.year[i])$cost[1]
  
  if(unique.year[i]<=1998){
    zt.rates1 <- subset(hhrates, rateYear==unique.year[i] & class=="3000")$cost[1];       
    zt.rates2 <- subset(hhrates, rateYear==unique.year[i] & class=="6000")$cost[1];
    zt.rates3 <- subset(hhrates, rateYear==unique.year[i] & class=="20000")$cost[1]; 
    
    zt.quarter = zt.flat + zt.rates1*3 + zt.rates2*3 + zt.rates3*(15-6)
    hh.quarter[i,"Flat"] <- zt.flat;
    hh.quarter[i,"cost15k"] <- zt.quarter;
  }
  
  if(unique.year[i]>1998){
    #zt.rates1 <- subset(hhrates, rateYear==unique.year[i] & class=="20000" & costUnit=="flat fee")$cost[1];       
    zt.rates2 <- subset(hhrates, rateYear==unique.year[i] & class=="20000" & costUnit=="per thousand gallons")$cost[1];
    
    zt.quarter = zt.flat + zt.rates2*15
    hh.quarter[i,"Flat"] <- zt.flat;
    hh.quarter[i,"cost15k"] <- zt.quarter;
  }
  
  }
hh.quarter
hh.quarter$Monthly = round(hh.quarter$cost15k/3,2)

#Plot Estimated monthly rates (note... I cannot duplicate their estimated values)
plot(hh.quarter$Year, hh.quarter$Monthly, pch=19,col="darkgray", cex=1.5, ylim=c(0,50), 
     ylab="Estimated Monthly Cost for 5kgal", 
     xlab="", main=paste0(rates$name[1],": Estimated Monthly Bill"))
lines(hh.quarter$Year, hh.quarter$Monthly, lwd=2, col="black")
```

